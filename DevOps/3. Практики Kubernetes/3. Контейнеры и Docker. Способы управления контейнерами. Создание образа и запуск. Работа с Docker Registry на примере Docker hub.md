# Урок 3. Контейнеры и Docker. Способы управления контейнерами. Создание образа и запуск. Работа с Docker Registry на примере Docker hub

#Контейнеры и #Docker

1. Что такое контейнеры
2. Как они были придуманы
3. Как сегодня используются контейнеры
# Что такое Docker

**Контейнеризация** — метод виртуализации, при котором ядро операционной системы поддерживает несколько изолированных вариантов пространства пользователя вместо одного. Эти варианты с точки зрения выполняемых процессов идентичны отдельному варианту операционной системы — их и принято называть контейнерами.

Как это выглядит на практике?

Это приложение вместе с необходимыми ему библиотеками и настройками, «завернутое» в некое подобие изолированной среды, которое может запускаться на любом Linux-сервере.

Контейнеризация позволяет унифицировать поставку и запуск приложений, а также помогает повысить эффективность процесса разработки:

●       упрощает передачу приложения заказчику;

●       обеспечивает тиражируемость;

●       повышает скорость развертывания;

●       гарантирует неизменность;

●       решает проблему несовместимости окружения.

По своей сути контейнеры близки к образам виртуальных машин за рядом исключений:

●       у контейнеров отсутствует слой гостевой ОС;

●       контейнеры запускаются на одной машине, изолируясь друг от друга механизмами контейнерного движка (Namespaces обеспечивает изоляцию, а CGroups — контроль выделения ресурсов);

●       в контейнер включено не только приложение, но и часть необходимых ему библиотек.

![[Pasted image 20241010175411.png]]
# Основные понятия

**Docker** — программное обеспечение для автоматизации развёртывания и управления приложениями в средах с поддержкой контейнеризации. Сегодня это наиболее популярная реализация решения для контейнеризации приложений.

**Docker image** — образ файловой системы, содержащий все необходимые библиотеки и исполняемые файлы для запуска, также описывающий сам запуск приложения.

**Docker container** — исполняемый кземпляр образа. Является совокупностью образа, выведенного в Mount NS, сетевой конфигурации, конфигурации постоянного хранилища (при необходимости).

**Volume, Persistent Volume** — внешняя по отношению к контейнеру файловая система, монтируемая в контейнер, для постоянного хранения данных.

**Docker Network** — псевдосеть, выделяемая контейнерам.

**Registry** — реестр, хранящий слои образов.

**Repository** — репозиторий, хранящий манифесты описания образов.

# Образы

**Docker image** — это неизменяемый образ, из которого разворачивается контейнер.

![[Pasted image 20241010175429.png]]

●       По сути представляет собой шаблон запускаемой изолированной программы.

●       Содержит базовый образ ОС для функционирования контейнера, грубо говоря, кусочек операционной системы с минимально необходимыми либами.

●       Хранит исключительно статические данные — только то, что «положили» при сборке.

●       При сборке контейнера может содержать код или исполняемый файл программы.

●       Является исходной точкой для создания контейнера —  при запуске образа стартуют все статичные слои, а также добавляется рантайм-слой, на котором и происходят все изменения от запущенного приложения.

# Создание образов

**Создание образов происходит автоматически** — путем написания специального Dockerfile и использования команды docker build. Dockerfile — текстовый файл, содержащий все инструкции для создания образа

Для сборки контейнера необходимо выполнить команду docker build . –t <>dockernametag<>.

Для запуска контейнера необходимо выполнить команду docker run --name test –it –p 127.00.0.1:8080.

Новый образ можно сделать из запущенного контейнера. Для этого нужно войти внутрь него и сохранить изменения командой docker commit.

# Тома в Docker

Docker предлагает несколько способов хранения данных.

## Тома хранения данных

**Volumes** — часть файловой системы, обслуживаемой докером (в linux / var / lib / docker / volumes). В Linux тома находятся по умолчанию в /var/lib/docker/volumes/. Это рекомендуемый разработчиками Docker способ хранения данных.

Тома создаются и управляются средствами Docker:

●       командой docker volume create;

●       через указание тома при создании контейнера в Dockerfile или docker-compose.yml.

В контейнере том отображается, как обычный каталог, который мы определяем в Dockerfile. Тома могут быть с именами или без — безымянным томам Docker сам присвоит имя.

Один том может быть примонтирован одновременно в несколько контейнеров. Когда никто не использует том, он не удаляется, а продолжает существовать.

## Монтирование каталогов с хоста

**Bind Mount** — это более простая концепция: файл или каталог с хоста просто монтируется в контейнер.

**Сценарии использования:**

●       Для проброса в контейнер конфигурационных файлов с хоста. Например, именно так в контейнерах реализуется DNS.

●       В разработке — код находится на хосте, но исполняется в контейнере.

**Особенности метода:**

●       Запись в примонтированный каталог могут вести программы как в контейнере, так и на хосте, что повышает риск случайного затирания данных.

●       Низкий уровень безопасности из-за трансляции прав root.

Не рекомендуется использовать в продакшене.

# В памяти

**tmpfs** — временное файловое хранилище, некая специально отведённая область в оперативной памяти. Как правило, используется для дебага, а не для долгосрочного хранения.

# Сеть в Docker

Для обеспечения доступа к приложению через сеть в Docker есть механизм прокидывания сети хоста.

Поскольку контейнеров на хосте может быть много, а сетевых интерфейсов — мало, как правило, контейнерам достается виртуальная псевдосеть.

Ее самая распространенная реализация — бриджи (сетевые мосты), которые использует сам Linux и системы виртуализации. В этой сети контейнеры запускаются по умолчанию. Связь устанавливается через bridge-интерфейс на хосте, виртуальный интерфейс veth внутри контейнера строит сетевой мост с интерфейсом хоста. Таким образом все контейнеры могут получить свою собственную подсеть и доступ к внешним сетям.

![[Pasted image 20241010175451.png]]

Кроме того, есть возможность создавать пользовательские настраиваемые мостовые сети для ручного объединения контейнерных подсетей и организации сетевого обмена внутри хоста.

Как правило, возможностей данного механизма в большинстве случаев хватает. Однако, если по каким-то причинам требуется другое решение, можно прокинуть физический порт/интерфейс хоста так сеть с помощью Host network. Она удаляет сетевую изоляцию между контейнером и хостом Docker и напрямую использует сеть хоста.

Если вы запускаете контейнер, который привязывается к порту 80, и используете хост-сеть, приложение контейнера будет доступно через порт 80 по IP-адресу хоста. Вместе с тем вы не сможете запускать несколько веб-контейнеров на одном хосте, используя один и тот же порт.

Чтобы сделать контейнер доступным исключительно локально, достаточно назначить ему заглушку в виде сетевого интерфейса типа none.

# Docker Registry

**Docker Registry** — это инструмент для хранения образов Docker. Представляет собой реестр, хранящий слои образов.

**Docker Hub** — открытый (публичный) репозиторий образов (хранилище) контейнеров, поддерживаемый Docker Inc.

Для собственный нужд можно завести локальный Registry и использовать его для работы с образами.

![[Pasted image 20241010175525.png]]

Основные возможности:

●       упрощает и улучшает управление правами доступа и безопасность образов;

●       управляет распространением образов;

●       интегрируется с рабочими процессами приложений;

●       можно настроить собственный реестр контейнеров.

# Репозиторий контейнеров

В терминологии Docker репозиторий — это набор образов, лежащих в Registry, с одинаковыми именами и разными тегами. Теги — это идентификаторы образов.

![[Pasted image 20241010175540.png]]

_Tag — версия образа/манифеста (по умолчанию latest)_

Обычно в репозиториях хранятся разные версии одних и тех же образов. Например, Python — это имя популярнейшего официального репозитория Docker на хабе (реджистри) Docker.

Основные фичи репозитория:

●       хранит образы контейнеров, доступные для создания своих контейнеров;

●       использует версионирование (последний образ — name:latest) и помогает удобно версионировать приложение в среде;

●       дает возможность откатиться на прошлую версию при необходимости.

# Docker Compose

Итак, Docker отлично справляется с запуском одного приложения в контейнере. Однако, как правило, сервис состоит из нескольких приложений — ведь это многокомпонентный продукт, который также содержит инструменты мониторинга, сбора логов и многое другое.

Для решения этой задачи был придуман Docker Compose.

**Docker Compose** — это инструмент, позволяющий запускать среды приложений с несколькими контейнерами на основе определений, задаваемых в файле YAML.

Он использует определения служб для построения полностью настраиваемых сред с несколькими контейнерами, которые могут использовать общие сети и тома хранения данных.

С его помощью можно развернуть сервис целиком и управлять сразу несколькими контейнерами.

И Docker, и Docker Compose оперируют контейнерами на одном сервере, и если он сломается, все, что было запущено сломается вместе с ним.

По этой причине сегодня Docker в чистом виде — это удел разработки и тестирования, а для запуска контейнеров в продакшене используются средства, которые позволяют запускать тысячи контейнеров и управлять ими.

# Использование Docker в среде разработки

Сегодня контейнерные технологии семимильными шагами захватывают ИТ-пространство. По статистике, 65% респондентов используют Docker и иные контейнерные технологии в процессе разработки, и 48% — для непрерывной интеграции.

# Подведем итоги

●       Контейнеризация — метод виртуализации, при котором ядро операционной системы поддерживает несколько изолированных вариантов пространства пользователя вместо одного.

●       Контейнеризация позволяет унифицировать поставку и запуск приложений, а также помогает повысить эффективность процесса разработки: упрощает передачу приложения заказчику, обеспечивает тиражируемость, повышает скорость развертывания, гарантирует неизменность, решает проблему несовместимости окружения.

●       Docker — программное обеспечение для автоматизации развёртывания и управления приложениями в средах с поддержкой контейнеризации.

●       Docker image — образ файловой системы, содержащий все необходимые библиотеки и исполняемые файлы для запуска, также описывающий сам запуск приложения.

●       Docker container — исполняемый экземпляр образа. Является совокупностью образа, выведенного в Mount NS, сетевой конфигурации, конфигурации постоянного хранилища (при необходимости).

●       Volume, Persistent Volume — внешняя по отношению к контейнеру файловая система, монтируемая в контейнер, для постоянного хранения данных.

●       Docker Network — псевдосеть, выделяемая контейнерам.

●       Registry — реестр, хранящий слои образов.

●       Repository — репозиторий, хранящий манифесты описания образов.

●       Docker image представляет собой шаблон запускаемой изолированной программы и является исходной точкой для создания контейнера.

●       Создание образов происходит автоматически — путем написания специального Dockerfile и использования команды docker build.

●       Docker предлагает несколько способов хранения данных.

●       Volumes — часть файловой системы, обслуживаемой докером (в linux / var / lib / docker / volumes). Это рекомендуемый разработчиками Docker способ хранения данных.

●       Bind Mount (монтирование каталогов с хоста) — монтирование файла или каталога с хоста просто монтируется в контейнер.

●       tmpfs — временное файловое хранилище, некая специально отведённая область в оперативной памяти.

●       Для обеспечения доступа к приложению через сеть в Docker есть механизм прокидывания сети хоста. Поскольку контейнеров на хосте может быть много, а сетевых интерфейсов — мало, контейнерам достается виртуальная псевдосеть.

●       Docker Registry — это инструмент для хранения образов Docker. Представляет собой реестр, хранящий слои образов.

●       Docker Hub — открытый (публичный) репозиторий образов (хранилище) контейнеров, поддерживаемый Docker Inc.

●       Для собственный нужд можно завести локальный Registry и использовать его для работы с образами.

●       Репозиторий — это набор образов, лежащих в Registry, с одинаковыми именами и разными тегами. Теги — это идентификаторы образов.

●       Docker Compose — это инструмент, позволяющий запускать среды приложений с несколькими контейнерами на основе определений, задаваемых в файле YAML. С его помощью можно развернуть сервис целиком и управлять сразу несколькими контейнерами.

●       Docker в чистом виде используется в разработке и тестировании, а для запуска контейнеров в продакшене используются средства, которые позволяют запускать тысячи контейнеров и управлять ими.

●       Сегодня 65% респондентов используют Docker и иные контейнерные технологии в процессе разработки, и 48% — для непрерывной интеграции.