# Урок 4. Особенности Kubernetes. Мониторинг в Kubernetes

#Особенности #Kubernetes. #Мониторинг
# Почему Kubernetes

Ненадолго окунемся в историю контейнерных технологии.

![[Pasted image 20241010175626.png]]

●       Человечество уже давно хотело придумать некое решение, которое бы позволило изолировать приложение и обеспечить его удобный перенос.

●       Все началось с Unix, где появились межсервисные взаимодействия и впервые был применен системный вызов chroot — древний предок изоляции — операция изменения корневого каталога в Unix-подобных операционных системах. Программа, запущенная с измененным корневым каталогом, будет иметь доступ только к тем файлам, которые содержатся в данном каталоге.

●       После этого в Unix-подобных системах появились jail freebsd и зоны solaris — механизмы виртуализации уровня ядра, позволяющие создавать внутри одной ОС несколько независимо работающих экземпляров.

●       С появлением Linux все стало еще интереснее, так как изначально его ядро развивалось с упором на изоляцию процессов и виртуализацию. Так в 2008 году появились LXC-контейнеры, а в 2013 — Docker.

●       В 2014 году компания Google представила свой механизм управления контейнерами — Kubernetes. Он разрешал все недостатки Docker. Контейнерные технологии захватывали рынки, тесно интегрируясь с парадигмой DevOps и SRE.

●       В 2015 году был представлен проект Open Container Initiative (OCI), за основу которого был взят стандарт Docker.

●       В 2017 году на базе этого стандарта был представлен открытый контейнерный движок CRI-O, а в 2018 Containerd — ранее часть Docker, а ныне самостоятельное решение, реализующее исполняемую среду для запуска контейнеров.

●       Сегодня, говоря о продуктивных контейнерных технологиях, мы, как правило, имеем в виду Kubernetes. В его сердце — лишь часть Docker, однако он остается на 100% совместим в работе с ним.

**Почему же Kubernetes так популярен?**

Он умеет все тоже что и Docker, а также позволяет удобно управлять большим количеством контейнеров в распределенной среде.

# Что такое Kubernetes

Kubernetes — это:

●       система управления кластерами и контейнеризированными приложениями (в терминологии k8s – pod);

●       разработка компании Google, позволяет одновременно запускать огромное количество контейнеров на большом количестве хостов (справляется с 5000 узлами и 300000 контейнерами).

Основные задачи Kubernetes:

●       масштабирование и балансировка контейнеров;

●       обеспечение непрерывной работы контейнеров в случае их передеплоя или падения.

Чем не является Kubernetes:

●       не определяет тип приложения — все, что работает в контейнере, может работать и в k8s;

●       не собирает контейнеры и не разворачивает исходный код;

●       не является IDS/IDP и не хранит аутентификационные данные приложений;

●       не предоставляет сервисы уровня приложений (middleware SQL MQ etc);

●       не предоставляет сервисы логирования, мониторинга, алертинга и т. п.

Что умеет Kubernetes:

●       балансировать нагрузку и обеспечивать избыточность разными механизмами;

●       устанавливать требуемые ресурсы на контейнеры, распределять контейнеры для лучшего распределения нагрузки на рабочие ноды;

●       автоматически подключать тома из внешнего хранилища, а также создавать эти тома во внешнем хранилище;

●       перезапускать контейнеры с ошибкой;

●       перезапускать контейнеры, которые не отвечают на пользовательские метрики;

●       хранить чувствительную информацию (пароли, токены и т.п.);

●       упрощать обновление приложений, отключая и обновляя только несколько копий за раз и повторяя это, пока все копии не будут заменены на новую версию.

# Концепции и понятия Kubernetes

**Node** — вычислительная мощность, сервер. Master и Worker.

**POD** — модель взаимосвязанных процессов, обеспечивающих рабочий экземпляр приложения. Один или несколько контейнеров.

**Workloads** — механизмы запуска и распределения нагрузки приложений.

**Service** — логический сервис, определяющий сетевой доступ к приложениям (ClusterIP, LoadBalancer, NodePort). Обычно обеспечивается Container Network Interface (CNI), подключенным к кластеру.

**Ingress** — объект API, который управляет внешним доступом к службам в кластере, обычно через HTTP(S). Может обеспечить балансировку нагрузки, терминацию SSL и виртуальный хостинг на основе имен.

**Volume** — директория с данными для постоянного или эфемерного хранения данных. Обычно обеспечивается Container Storage Interface (CSI), подключенным к кластеру.

**Label** — ключи-значения, прикрепленные к объектам кластера, используемые для управления.

**Kubectl** — командный интерфейс управления кластером.

# Как устроен Kubernetes

**Kubernetes API Server** — обеспечивает работу API-сервера. Базовая функция API-сервера Kubernetes это приём данных, хранение и возврат по запросу.

**Scheduler** — отвечает за привязку подов к нодам.

**Controller** **Manager** — отвечает за управление состоянием кластера.

**Etcd** — состояние мастера, конфигурации, уведомление о состоянии элементов кластера.

**Kubelet** — отвечает за управление контейнерами. Осуществляет наблюдение за набором подов, привязанных к его ноде, и обеспечивает выполнение этих подов.

**Kube**-**proxy** — компонент Kubernetes, который обрабатывает трафик маршрутизации для служб в кластере. Отвечает за управление потоками запросов, идущих по сети.

**Container** **runtime** — непосредственно движок контейнеров (Docker/ CRI-O/ Containerd).

![[Pasted image 20241010175646.png]]
_Архитектура Kubernetes_

# Мониторинг для K8S

Сам по себе Kubernetes не является сервисом мониторинга, но этот функционал можно в него доставить. Более того — сделать это необходимо, поскольку без знаний о жизнедеятельности приложений и самого кластера мы не можем эффективно осуществлять их поддержку.

Для этого нам надо получать следующие данные:

●       Состояние инфраструктуры. Загрузка CPU на нодах, утилизация памяти, как работает и насколько занят тот или иной диск и пр.

●       Control Plane компоненты: API, Scheduler, etcd.

●       Состояние контейнеров (POD Status).

●       Статусы сетевой доступности.

●       Метрики приложения.

# Методы мониторинга

**Мониторинг доступности.** Жив или нет под, доступен или недоступен сервис.

**Мониторинг нагрузки.** CPU, RAM, диск, RPS, нагрузки на базу и пр.

**Мониторинг ошибок.**  Количество ошибок от сервиса или отношение ошибок к успешным вызовам.

**Мониторинг логики (мониторинг продукта).** Метрики SRE — задержки, прохождение флоу, время отклика, количество обращений к ресурсу, количество сессий, время сессии и многое другое.

**Событийный мониторинг (мониторинг безопасности).** Все что может быть передано в SIEM и расцениваться как угроза.

# Инструменты для мониторинга

Решений для мониторинга — целое множество и все они по-своему хороши. Однако для работы в связке с Kubernetes желательно, чтобы инструмент интегрировался с k8s, а еще лучше — чтобы в нем уже были готовые шаблоны правил мониторинга и алертов.

Посмотрим, какие инструменты мониторинга k8s наиболее популярны.

**Prometheus / Grafana.** Хорошая интеграция с k8s, поддерживает множество приложений, обеспечивает мониторинг инфраструктуры, приложений и их нагрузки, позволяет собирать данные метрик об использовании приложений.

**Victoria Metrics (vmagent).** Легковесный сборщик метрик с приложений и инфраструктуры, отлично подходит для мониторинга приложений.

**Zabbix.** Распространенная система мониторинга, которая может эффективно интегрироваться с k8s и собирать метрики с приложений в нем.

**Elastic stack.** Полный стек для логирования и мониторинга, позволяет закрыть множество проблем с логированием и отчасти мониторингом.

# Поведем итоги

●       Kubernetes — это система управления кластерами и контейнеризированными приложениями (в терминологии k8s – pod). Ее разработала компания Google.

●       Kubernetes позволяет одновременно запускать огромное количество контейнеров на большом количестве хостов (справляется с 5000 узлами и 300000 контейнерами).

●       Основные задачи Kubernetes — масштабирование и балансировка контейнеров, обеспечение их непрерывной работы.

●       Без знаний о жизнедеятельности приложений и самого кластера мы не можем эффективно осуществлять их поддержку. В рамках мониторинга Kubernetes нам необходимо получать данные о состоянии инфраструктуры, Control Plane компонентах, состоянии контейнеров, статусы сетевой активности, метрики приложения.

●       Мониторинг Kubernetes включает мониторинг доступности, нагрузки, ошибок, логики, событийный мониторинг.

●       В качестве инструментов мониторинга наиболее часто используются Prometheus / Grafana, Victoria Metrics (vmagent), Zabbix, Elastic stack.