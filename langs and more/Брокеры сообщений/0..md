![[forupscale (2).png]]
4 сервиса - producer(создают сообщения)
1 сервис - consumer(потребляет)
Много разных сервисов общаются с сервисом уведомлений чтобы пришло уведомление клиенту.

Но в такой системе много проблем:
1. Всем сервисам слева нужно знать какой адрес у сервиса уведомлений(ip адрес, домен, порт). **Если сервис уведомлений переедет, то придется менять адреса назначения у всех подключенных к нему сервисов**
2. Все уведомления отправляются через HTTP, т.е. они нигде не хранятся. Может быть такое что **сервис получил запрос и с ним что-то произошло и тогда получается что этот запрос больше никогда не будет никуда отправлен**
3. Пиковые нагрузки на сервис. **Сервис У не справится с большим кол-вом уведомлений от левых сервисов**
Все эти проблемы закрывает брокер сообщений.

![[Pasted image 20241121142026.png]]
Теперь все сообщения от левых сервисов приходят с начало в брокер сообщений, а только потом в сервис уведомлений. Сообщения могут хранится в брокере и поэтому сервис уведомлений не переполняется уведомлениями.

Сервис уведомлений сам входит в брокер, собирает определенное кол-во сообщений, выполняет их и потом снова приходит за уведомлениями.

После развертывания брокера на конкретном сервере или нескольких серверах и все сервисы в системе знают адрес этого брокера. Обычно брокер не переезжает никуда.

Сообщения бывают в формате json.

Брокер является связующим звеном в микросервисной архитектуре.

Брокеры сообщений снимают лишнюю нагрузку с сервисов системы. Сервисам не нужно ждать ответа от сервиса уведомлений(уведомление обработано/ отправлено), это занимает время и нагружает сервисы.

Apache Kafka - самый популярный брокер сообщений в бигтех компаниях. Почему?
1. Выдерживает колоссальную нагрузку 1млн запросов/cек
2. Легко масштабировать. Добавляете сервера, везде ставите Kafk'у и все работает. Kafka изначально заточена под масштабирование горизонтально (добавление на новых серверах)
3. Kafka хранит все сообщения(месяц, полгода, год)

RabbitMQ:
1. Легко развернуть, даже не своем ПК
2. Можно легко отложить сообщения(например, неприоритетное сообщение и отложить его в конец очереди). В Kafk'е хранится гарантированный порядок сообщений(как пришли так и выйдут)
3. Удобное масштабирование консьюмеров (сервисов которые будут считывать сообщения и т.о. можно быстро раскидать сообщения, подключив доп. сервисы которые будут считывать и обрабатывать эти сообщения)
4. 
![[Pasted image 20241121145152.png]]

NATSio

Через брокер сообщений не перенаправляем большие объемы данных, а только маленькие json-файлы
